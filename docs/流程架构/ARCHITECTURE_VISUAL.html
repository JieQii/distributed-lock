<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆ†å¸ƒå¼é”ç³»ç»Ÿ - å¯è§†åŒ–æ¶æ„æ–‡æ¡£</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            padding: 40px;
        }

        h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 40px;
            font-size: 1.2em;
        }

        h2 {
            color: #764ba2;
            margin-top: 40px;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
            font-size: 1.8em;
        }

        h3 {
            color: #555;
            margin-top: 30px;
            margin-bottom: 15px;
            font-size: 1.4em;
        }

        .diagram-container {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .mermaid {
            text-align: center;
            background: white;
            padding: 20px;
            border-radius: 5px;
        }

        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }

        .warning-box {
            background: #fff3e0;
            border-left: 4px solid #ff9800;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }

        .success-box {
            background: #e8f5e9;
            border-left: 4px solid #4caf50;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }

        .toc {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }

        .toc ul {
            list-style: none;
            padding-left: 0;
        }

        .toc li {
            margin: 10px 0;
        }

        .toc a {
            color: #667eea;
            text-decoration: none;
            font-weight: 500;
        }

        .toc a:hover {
            text-decoration: underline;
        }

        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .feature-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .feature-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            border-color: #667eea;
        }

        .feature-card h4 {
            color: #667eea;
            margin-bottom: 10px;
        }

        code {
            background: #f4f4f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”’ åˆ†å¸ƒå¼é”ç³»ç»Ÿ</h1>
        <p class="subtitle">å¯è§†åŒ–æ¶æ„æ–‡æ¡£ - å®Œæ•´ç³»ç»Ÿè®¾è®¡æ¦‚è§ˆ</p>

        <div class="toc">
            <h3>ğŸ“‘ ç›®å½•</h3>
            <ul>
                <li><a href="#overview">1. ç³»ç»Ÿæ¦‚è§ˆ</a></li>
                <li><a href="#architecture">2. æ¶æ„è®¾è®¡</a></li>
                <li><a href="#components">3. æ ¸å¿ƒç»„ä»¶</a></li>
                <li><a href="#flow">4. å…³é”®æµç¨‹</a></li>
                <li><a href="#lock-design">5. é”è®¾è®¡</a></li>
                <li><a href="#features">6. ç‰¹æ€§è¯´æ˜</a></li>
            </ul>
        </div>

        <section id="overview">
            <h2>1. ç³»ç»Ÿæ¦‚è§ˆ</h2>
            
            <div class="info-box">
                <strong>ç³»ç»Ÿç›®æ ‡ï¼š</strong>ç®¡ç†é•œåƒå±‚ä¸‹è½½çš„åˆ†å¸ƒå¼é”ç³»ç»Ÿï¼Œç¡®ä¿åŒä¸€é•œåƒå±‚åœ¨åŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªèŠ‚ç‚¹èƒ½å¤Ÿä¸‹è½½ã€‚
            </div>

            <div class="diagram-container">
                <h3>æ•´ä½“æ¶æ„å›¾</h3>
                <div class="mermaid">
graph TB
    subgraph Content["ğŸ“¦ Content æ’ä»¶å±‚"]
        Writer[Writer<br/>ä¸šåŠ¡é€»è¾‘å¤„ç†]
        RefCountMgr[RefCountManager<br/>å¼•ç”¨è®¡æ•°ç®¡ç†]
        RefCountStorage[RefCountStorage<br/>æœ¬åœ°å­˜å‚¨]
    end

    subgraph Client["ğŸŒ Client åŒ…"]
        LockClient[LockClient<br/>HTTPå®¢æˆ·ç«¯<br/>ShortClient/LongClient]
    end

    subgraph Server["ğŸ–¥ï¸ Server ç«¯"]
        Handler[Handler<br/>HTTPæ¥å£]
        LockManager[LockManager<br/>é”ç®¡ç†å™¨<br/>32ä¸ªåˆ†æ®µé”]
        Shard[resourceShard<br/>ç‰©ç†é”+çŠ¶æ€+é˜Ÿåˆ—]
    end

    Writer -->|1. åˆ¤æ–­æ˜¯å¦æ‰§è¡Œ| RefCountMgr
    RefCountMgr -->|2. è¯»å–è®¡æ•°| RefCountStorage
    Writer -->|3. è¯·æ±‚é”| LockClient
    LockClient -->|4. POST /lock| Handler
    Handler -->|5. TryLock| LockManager
    LockManager -->|6. ç®¡ç†| Shard
                </div>
            </div>

            <div class="feature-grid">
                <div class="feature-card">
                    <h4>ğŸ” åˆ†å¸ƒå¼é”</h4>
                    <p>ç¡®ä¿åŒä¸€èµ„æºåŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªèŠ‚ç‚¹æ“ä½œ</p>
                </div>
                <div class="feature-card">
                    <h4>ğŸ“Š åˆ†æ®µé”</h4>
                    <p>32ä¸ªåˆ†æ®µï¼Œæå‡å¹¶å‘æ€§èƒ½</p>
                </div>
                <div class="feature-card">
                    <h4>ğŸ”’ ç‰©ç†é”</h4>
                    <p>æ¯ä¸ªèµ„æºç‹¬ç«‹çš„äº’æ–¥é”</p>
                </div>
                <div class="feature-card">
                    <h4>ğŸ“ˆ å¼•ç”¨è®¡æ•°</h4>
                    <p>å®¢æˆ·ç«¯åˆ¤æ–­æ˜¯å¦æ‰§è¡Œæ“ä½œ</p>
                </div>
                <div class="feature-card">
                    <h4>ğŸ”„ ç­‰å¾…é˜Ÿåˆ—</h4>
                    <p>FIFOé˜Ÿåˆ—ç®¡ç†é”è¯·æ±‚</p>
                </div>
                <div class="feature-card">
                    <h4>ğŸ“¡ SSEè®¢é˜…</h4>
                    <p>å®æ—¶é€šçŸ¥é”çŠ¶æ€å˜åŒ–</p>
                </div>
            </div>
        </section>

        <section id="architecture">
            <h2>2. æ¶æ„è®¾è®¡</h2>

            <div class="diagram-container">
                <h3>ä¸‰å±‚æ¶æ„</h3>
                <div class="mermaid">
graph LR
    subgraph Layer1["åº”ç”¨å±‚"]
        A1[Contentæ’ä»¶]
        A2[ä¸šåŠ¡é€»è¾‘]
    end

    subgraph Layer2["å®¢æˆ·ç«¯å±‚"]
        B1[LockClient]
        B2[HTTPè¯·æ±‚]
        B3[SSEè®¢é˜…]
    end

    subgraph Layer3["æœåŠ¡ç«¯å±‚"]
        C1[Handler]
        C2[LockManager]
        C3[resourceShard]
    end

    A1 --> B1
    A2 --> B1
    B1 --> B2
    B1 --> B3
    B2 --> C1
    B3 --> C1
    C1 --> C2
    C2 --> C3
                </div>
            </div>
        </section>

        <section id="components">
            <h2>3. æ ¸å¿ƒç»„ä»¶</h2>

            <div class="diagram-container">
                <h3>LockManager ç»“æ„</h3>
                <div class="mermaid">
classDiagram
    class LockManager {
        -shards: [32]*resourceShard
        -AllowMultiNodeDownload: bool
        +TryLock(request) bool, bool, string
        +Unlock(request) bool
        +getShard(resourceID) *resourceShard
    }

    class resourceShard {
        -mu: sync.RWMutex
        -resourceLocks: map[string]*sync.Mutex
        -locks: map[string]*LockInfo
        -queues: map[string][]*LockRequest
        -subscribers: map[string][]Subscriber
    }

    class LockInfo {
        +Request: *LockRequest
        +AcquiredAt: time.Time
        +Completed: bool
        +Success: bool
    }

    LockManager "1" --> "32" resourceShard
    resourceShard "1" --> "*" LockInfo
                </div>
            </div>

            <div class="diagram-container">
                <h3>Client ç»“æ„</h3>
                <div class="mermaid">
classDiagram
    class LockClient {
        -ServerURL: string
        -ShortClient: *http.Client
        -LongClient: *http.Client
        -NodeID: string
        +Lock(ctx, request) *LockResult, error
        +Unlock(ctx, request) error
        -tryLockOnce() *LockResult, error
        -waitForLock() *LockResult, error
    }

    class LockResult {
        +Acquired: bool
        +Error: error
    }

    LockClient --> LockResult
                </div>
            </div>

            <div class="diagram-container">
                <h3>Callback åŒ…ç»“æ„</h3>
                <div class="mermaid">
classDiagram
    class RefCountManager {
        -storage: RefCountStorage
        +ShouldSkipOperation() bool, string
        +UpdateRefCount()
        +GetRefCount() *ReferenceCount
    }

    class RefCountStorage {
        <<interface>>
        +GetRefCount() *ReferenceCount
        +SetRefCount()
        +DeleteRefCount()
    }

    class ReferenceCount {
        +Count: int
        +Nodes: map[string]bool
    }

    RefCountManager --> RefCountStorage
    RefCountStorage --> ReferenceCount
                </div>
            </div>
        </section>

        <section id="flow">
            <h2>4. å…³é”®æµç¨‹</h2>

            <div class="diagram-container">
                <h3>Pull æ“ä½œå®Œæ•´æµç¨‹</h3>
                <div class="mermaid">
sequenceDiagram
    participant W as Writer
    participant R as RefCountManager
    participant C as LockClient
    participant S as LockManager
    participant Sh as resourceShard

    W->>R: ShouldSkipOperation()
    R->>R: GetRefCount()
    alt refCount > 0
        R-->>W: skip=true
        W-->>W: è·³è¿‡æ“ä½œ
    else refCount == 0
        R-->>W: skip=false
        W->>C: Lock(request)
        C->>S: POST /lock
        S->>Sh: getShard(resourceID)
        S->>Sh: è·å–åˆ†æ®µé”
        S->>Sh: æ£€æŸ¥/åˆ›å»ºèµ„æºé”
        S->>Sh: è·å–èµ„æºé”(ç‰©ç†é”)
        alt é”ä¸å­˜åœ¨
            S->>Sh: åˆ›å»ºLockInfo
            S-->>C: acquired=true
        else é”è¢«å ç”¨
            alt AllowMultiNodeDownload=false
                S-->>C: acquired=false, error
            else AllowMultiNodeDownload=true
                S->>Sh: åŠ å…¥ç­‰å¾…é˜Ÿåˆ—
                S-->>C: acquired=false
                C->>C: waitForLock (SSE)
            end
        end
        C-->>W: LockResult
        W->>W: æ‰§è¡ŒPullæ“ä½œ
        W->>C: Unlock(request)
        C->>S: POST /unlock
        S->>Sh: é‡Šæ”¾èµ„æºé”
        alt æ“ä½œæˆåŠŸ
            S->>Sh: åˆ é™¤é”å’Œèµ„æºé”
        else æ“ä½œå¤±è´¥
            S->>Sh: ä¿ç•™èµ„æºé”
            S->>Sh: processQueue
        end
        W->>R: UpdateRefCount()
        R->>R: refCount.Count++
    end
                </div>
            </div>

            <div class="diagram-container">
                <h3>åˆ†æ®µé”å¹¶å‘å¤„ç†</h3>
                <div class="mermaid">
sequenceDiagram
    participant A as èŠ‚ç‚¹A<br/>resource1
    participant B as èŠ‚ç‚¹B<br/>resource2
    participant C as èŠ‚ç‚¹C<br/>resource1
    participant S1 as åˆ†æ®µ1
    participant S2 as åˆ†æ®µ2

    par ä¸åŒåˆ†æ®µå¹¶å‘
        A->>S1: TryLock(resource1)
        S1->>S1: è·å–åˆ†æ®µé”
        S1-->>A: acquired=true
    and
        B->>S2: TryLock(resource2)
        S2->>S2: è·å–åˆ†æ®µé”
        S2-->>B: acquired=true
    end

    Note over A,B: ä¸åŒåˆ†æ®µå¯ä»¥å¹¶å‘æ‰§è¡Œ

    C->>S1: TryLock(resource1)
    S1->>S1: æ£€æŸ¥locks map
    S1-->>C: acquired=false (é”è¢«å ç”¨)
    S1->>S1: åŠ å…¥ç­‰å¾…é˜Ÿåˆ—
                </div>
            </div>

            <div class="diagram-container">
                <h3>ç‰©ç†é”è·å–é¡ºåº</h3>
                <div class="mermaid">
sequenceDiagram
    participant C as Client
    participant L as LockManager
    participant S as resourceShard

    C->>L: TryLock(request)
    L->>S: getShard(resourceID)
    
    Note over S: é˜¶æ®µ1: è·å–åˆ†æ®µé”ï¼Œæ£€æŸ¥/åˆ›å»ºèµ„æºé”
    L->>S: shard.mu.Lock()
    alt èµ„æºé”å­˜åœ¨
        L->>S: è·å–resourceLockå¼•ç”¨
    else èµ„æºé”ä¸å­˜åœ¨
        L->>S: åˆ›å»ºresourceLock
    end
    L->>S: shard.mu.Unlock()
    
    Note over S: é˜¶æ®µ2: è·å–èµ„æºé”(ç‰©ç†é”)
    L->>S: resourceLock.Lock()
    
    Note over S: é˜¶æ®µ3: é‡æ–°è·å–åˆ†æ®µé”è®¿é—®locks map
    L->>S: shard.mu.RLock()
    L->>S: æ£€æŸ¥locks[key]
    L->>S: shard.mu.RUnlock()
    
    Note over S: é˜¶æ®µ4: æ ¹æ®æ£€æŸ¥ç»“æœå¤„ç†
    alt é”ä¸å­˜åœ¨
        L->>S: åˆ›å»ºLockInfo
    end
    
    L->>S: resourceLock.Unlock()
    L-->>C: è¿”å›ç»“æœ
                </div>
            </div>
        </section>

        <section id="lock-design">
            <h2>5. é”è®¾è®¡</h2>

            <div class="diagram-container">
                <h3>åˆ†æ®µé”ç»“æ„</h3>
                <div class="mermaid">
graph TB
    subgraph LM["LockManager"]
        Shards[32ä¸ªresourceShard]
    end

    subgraph Shard["resourceShard (å•ä¸ªåˆ†æ®µ)"]
        SL[åˆ†æ®µé”<br/>sync.RWMutex]
        RL[resourceLocks<br/>ç‰©ç†é”map]
        L[locks<br/>é”çŠ¶æ€map]
        Q[queues<br/>ç­‰å¾…é˜Ÿåˆ—map]
        Sub[subscribers<br/>SSEè®¢é˜…è€…map]
    end

    Shards --> Shard
    Shard --> SL
    Shard --> RL
    Shard --> L
    Shard --> Q
    Shard --> Sub
                </div>
            </div>

            <div class="diagram-container">
                <h3>åˆ†æ®µé”å“ˆå¸Œåˆ†å¸ƒ</h3>
                <div class="mermaid">
graph LR
    R1[resource1] -->|FNV-1a| S1[åˆ†æ®µ1]
    R2[resource2] -->|FNV-1a| S2[åˆ†æ®µ2]
    R3[resource3] -->|FNV-1a| S3[åˆ†æ®µ3]
    RN[resourceN] -->|FNV-1a| S32[åˆ†æ®µ32]
    
    S1 --> C1[å¹¶å‘å¤„ç†]
    S2 --> C2[å¹¶å‘å¤„ç†]
    S3 --> C3[å¹¶å‘å¤„ç†]
    S32 --> C32[å¹¶å‘å¤„ç†]
                </div>
            </div>

            <div class="success-box">
                <strong>âœ… åˆ†æ®µé”ä¼˜åŠ¿ï¼š</strong>
                <ul>
                    <li>32ä¸ªåˆ†æ®µï¼Œç†è®ºä¸Šæ”¯æŒ32ä¸ªä¸åŒèµ„æºçš„å¹¶å‘æ“ä½œ</li>
                    <li>ä½¿ç”¨ FNV-1a å“ˆå¸Œç®—æ³•ï¼Œç¡®ä¿åŒä¸€ resourceID çš„æ‰€æœ‰æ“ä½œç±»å‹åˆ†åˆ°åŒä¸€åˆ†æ®µ</li>
                    <li>åˆ†æ®µé”ä½¿ç”¨ RWMutexï¼Œè¯»æ“ä½œå¯ä»¥å¹¶å‘</li>
                </ul>
            </div>
        </section>

        <section id="features">
            <h2>6. ç‰¹æ€§è¯´æ˜</h2>

            <h3>6.1 å¤šèŠ‚ç‚¹ä¸‹è½½æ¨¡å¼</h3>
            <div class="diagram-container">
                <div class="mermaid">
stateDiagram-v2
    [*] --> æ£€æŸ¥é…ç½®: TryLockè¯·æ±‚
    æ£€æŸ¥é…ç½® --> å¤šèŠ‚ç‚¹æ¨¡å¼å¼€å¯: AllowMultiNodeDownload=true
    æ£€æŸ¥é…ç½® --> å¤šèŠ‚ç‚¹æ¨¡å¼å…³é—­: AllowMultiNodeDownload=false
    
    å¤šèŠ‚ç‚¹æ¨¡å¼å¼€å¯ --> é”è¢«å ç”¨: æ£€æŸ¥é”çŠ¶æ€
    é”è¢«å ç”¨ --> åŠ å…¥é˜Ÿåˆ—: åŠ å…¥ç­‰å¾…é˜Ÿåˆ—
    åŠ å…¥é˜Ÿåˆ— --> SSEè®¢é˜…: ç­‰å¾…é”é‡Šæ”¾
    
    å¤šèŠ‚ç‚¹æ¨¡å¼å…³é—­ --> é”è¢«å ç”¨: æ£€æŸ¥é”çŠ¶æ€
    é”è¢«å ç”¨ --> ç›´æ¥è¿”å›å¤±è´¥: ä¸åŠ å…¥é˜Ÿåˆ—
    
    å¤šèŠ‚ç‚¹æ¨¡å¼å¼€å¯ --> é”å¯ç”¨: æ£€æŸ¥é”çŠ¶æ€
    å¤šèŠ‚ç‚¹æ¨¡å¼å…³é—­ --> é”å¯ç”¨: æ£€æŸ¥é”çŠ¶æ€
    é”å¯ç”¨ --> è·å–é”æˆåŠŸ: åˆ›å»ºLockInfo
                </div>
            </div>

            <div class="info-box">
                <strong>é…ç½®æ–¹å¼ï¼š</strong>é€šè¿‡ç¯å¢ƒå˜é‡ <code>ALLOW_MULTI_NODE_DOWNLOAD</code> æ§åˆ¶
                <ul>
                    <li><code>true</code> (é»˜è®¤): å…è®¸å¤šèŠ‚ç‚¹ä¸‹è½½ï¼Œé”è¢«å ç”¨æ—¶åŠ å…¥ç­‰å¾…é˜Ÿåˆ—</li>
                    <li><code>false</code>: ç¦æ­¢å¤šèŠ‚ç‚¹ä¸‹è½½ï¼Œé”è¢«å ç”¨æ—¶ç›´æ¥è¿”å›å¤±è´¥</li>
                </ul>
            </div>

            <h3>6.2 å¼•ç”¨è®¡æ•°ç®¡ç†</h3>
            <div class="diagram-container">
                <div class="mermaid">
stateDiagram-v2
    [*] --> Pullæ“ä½œ: æ“ä½œæˆåŠŸ
    [*] --> Updateæ“ä½œ: æ“ä½œæˆåŠŸ
    [*] --> Deleteæ“ä½œ: æ“ä½œæˆåŠŸ
    
    Pullæ“ä½œ --> å¼•ç”¨è®¡æ•°åŠ 1: refCount.Count++
    Updateæ“ä½œ --> å¼•ç”¨è®¡æ•°ä¸å˜: ä¸æ”¹å˜
    Deleteæ“ä½œ --> åˆ é™¤å¼•ç”¨è®¡æ•°: DeleteRefCount
    
    Pullæ“ä½œ --> æ“ä½œå¤±è´¥: æ“ä½œå¤±è´¥
    Updateæ“ä½œ --> æ“ä½œå¤±è´¥: æ“ä½œå¤±è´¥
    Deleteæ“ä½œ --> æ“ä½œå¤±è´¥: æ“ä½œå¤±è´¥
    æ“ä½œå¤±è´¥ --> å¼•ç”¨è®¡æ•°ä¸å˜: ä¸æ›´æ–°
                </div>
            </div>

            <div class="info-box">
                <strong>å¼•ç”¨è®¡æ•°è§„åˆ™ï¼š</strong>
                <ul>
                    <li><strong>Pullæ“ä½œæˆåŠŸï¼š</strong>å¼•ç”¨è®¡æ•°+1</li>
                    <li><strong>Updateæ“ä½œï¼š</strong>ä¸æ”¹å˜å¼•ç”¨è®¡æ•°</li>
                    <li><strong>Deleteæ“ä½œæˆåŠŸï¼š</strong>åˆ é™¤å¼•ç”¨è®¡æ•°</li>
                    <li><strong>æ“ä½œå¤±è´¥ï¼š</strong>ä¸æ›´æ–°å¼•ç”¨è®¡æ•°</li>
                </ul>
            </div>

            <h3>6.3 æ•°æ®æµ</h3>
            <div class="diagram-container">
                <div class="mermaid">
flowchart TD
    Start([èŠ‚ç‚¹è¯·æ±‚Pullèµ„æº]) --> CheckRefCount{æ£€æŸ¥å¼•ç”¨è®¡æ•°}
    CheckRefCount -->|refCount > 0| Skip[è·³è¿‡æ“ä½œ]
    CheckRefCount -->|refCount == 0| TryLock[è¯·æ±‚é”]
    
    TryLock --> GetShard[getShard]
    GetShard --> ShardLock[è·å–åˆ†æ®µé”]
    ShardLock --> CheckResourceLock{èµ„æºé”å­˜åœ¨?}
    
    CheckResourceLock -->|ä¸å­˜åœ¨| CreateRL[åˆ›å»ºèµ„æºé”]
    CheckResourceLock -->|å­˜åœ¨| GetRL[è·å–èµ„æºé”å¼•ç”¨]
    
    CreateRL --> ReleaseSL[é‡Šæ”¾åˆ†æ®µé”]
    GetRL --> ReleaseSL
    ReleaseSL --> AcquireRL[è·å–èµ„æºé”]
    
    AcquireRL --> ReacquireSL[é‡æ–°è·å–åˆ†æ®µé”]
    ReacquireSL --> CheckLockInfo{æ£€æŸ¥locks map}
    
    CheckLockInfo -->|é”ä¸å­˜åœ¨| CreateLI[åˆ›å»ºLockInfo]
    CheckLockInfo -->|é”è¢«å ç”¨| CheckMultiNode{å¤šèŠ‚ç‚¹ä¸‹è½½?}
    
    CheckMultiNode -->|å…³é—­| ReturnFail[è¿”å›å¤±è´¥]
    CheckMultiNode -->|å¼€å¯| AddToQueue[åŠ å…¥é˜Ÿåˆ—]
    AddToQueue --> WaitLock[SSEè®¢é˜…ç­‰å¾…]
    
    CreateLI --> ExecuteOp[æ‰§è¡ŒPullæ“ä½œ]
    WaitLock -->|é”è¢«åˆ†é…| ExecuteOp
    
    ExecuteOp --> UpdateRefCount[æ›´æ–°å¼•ç”¨è®¡æ•°]
    UpdateRefCount --> Unlock[é‡Šæ”¾é”]
    
    Unlock --> CheckSuccess{æ“ä½œæˆåŠŸ?}
    CheckSuccess -->|æˆåŠŸ| DeleteLock[åˆ é™¤é”å’Œèµ„æºé”]
    CheckSuccess -->|å¤±è´¥| KeepRL[ä¿ç•™èµ„æºé”]
    
    DeleteLock --> End([å®Œæˆ])
    KeepRL --> End
    Skip --> End
    ReturnFail --> End
                </div>
            </div>
        </section>

        <div class="warning-box">
            <strong>ğŸ“ è¯´æ˜ï¼š</strong>
            <p>æœ¬æ–‡æ¡£ä½¿ç”¨ Mermaid å›¾è¡¨ï¼Œå¯ä»¥åœ¨æ”¯æŒ Mermaid çš„ç¯å¢ƒä¸­ç›´æ¥å¯è§†åŒ–ã€‚å¦‚æœå›¾è¡¨æ— æ³•æ˜¾ç¤ºï¼Œè¯·ç¡®ä¿ï¼š</p>
            <ul>
                <li>ä½¿ç”¨æ”¯æŒ Mermaid çš„ Markdown æŸ¥çœ‹å™¨ï¼ˆå¦‚ GitHubã€VS Codeï¼‰</li>
                <li>æˆ–åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€æ­¤ HTML æ–‡ä»¶</li>
                <li>æˆ–è®¿é—® <a href="https://mermaid.live/" target="_blank">Mermaid Live Editor</a> æŸ¥çœ‹</li>
            </ul>
        </div>
    </div>

    <script>
        mermaid.initialize({ 
            startOnLoad: true,
            theme: 'default',
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis'
            },
            sequence: {
                diagramMarginX: 50,
                diagramMarginY: 10,
                actorMargin: 50,
                width: 150,
                height: 65,
                boxMargin: 10,
                boxTextMargin: 5,
                noteMargin: 10,
                messageMargin: 35
            }
        });
    </script>
</body>
</html>

