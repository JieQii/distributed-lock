# 分段锁性能量化总结

## 快速答案

### 1. 分段锁能支持多少并发？

**当前配置（32个分段）**：
- **理论最大并发度**：**32**
- **实际并发度**：**10-32**（取决于资源分布）

**含义**：同一时刻最多可以有32个不同资源的操作并发执行。

### 2. 全局锁能支持多少并发？

**全局锁（无分段）**：
- **理论最大并发度**：**1**
- **实际并发度**：**1**

**含义**：同一时刻只能有1个操作执行，所有操作串行。

### 3. 性能提升量化数据

| 资源数量 | 全局锁耗时 | 分段锁耗时（理想） | 分段锁耗时（实际） | 性能提升 |
|---------|-----------|------------------|------------------|---------|
| 32 | 320ms | 10ms | 10-15ms | **21-32倍** |
| 64 | 640ms | 20ms | 25-40ms | **16-25倍** |
| 100 | 1000ms | 31.25ms | 40-60ms | **16-25倍** |
| 200 | 2000ms | 62.5ms | 80-120ms | **16-25倍** |
| 500 | 5000ms | 156ms | 200-300ms | **16-25倍** |

**假设**：每个操作耗时10ms，资源均匀分布

## 详细分析

### 并发度计算公式

```
分段锁并发度 = min(shardCount, 不同资源数量)
全局锁并发度 = 1

总耗时 = max(各分段耗时) = max(各分段请求数) × 单操作耗时
性能提升 = 全局锁耗时 / 分段锁耗时
```

### 实际场景示例

#### 示例1：镜像下载（50个层）

**场景**：
- 50个不同的镜像层
- 每个层下载耗时10秒
- 32个分段

**全局锁**：
```
总耗时：50 × 10秒 = 500秒（8.3分钟）
并发度：1
```

**分段锁**：
```
理想情况：50/32 × 10秒 ≈ 15.6秒
实际情况：20-30秒（考虑不均匀分布）
并发度：32（理想）
性能提升：16-25倍
```

#### 示例2：高并发场景（200个不同资源）

**场景**：
- 200个不同的资源
- 每个操作耗时5秒
- 32个分段

**全局锁**：
```
总耗时：200 × 5秒 = 1000秒（16.7分钟）
并发度：1
```

**分段锁**：
```
理想情况：200/32 × 5秒 ≈ 31.25秒
实际情况：40-60秒（考虑不均匀分布）
并发度：32（理想）
性能提升：16-25倍
```

## 分段数对性能的影响

### 不同分段数的并发能力

| 分段数 | 理论最大并发度 | 100个资源耗时（理想） | 性能提升 |
|--------|--------------|---------------------|---------|
| 1（全局锁） | 1 | 1000ms | 1倍（基准） |
| 8 | 8 | 125ms | 8倍 |
| 16 | 16 | 62.5ms | 16倍 |
| **32** | **32** | **31.25ms** | **32倍** |
| 64 | 64 | 15.6ms | 64倍 |
| 128 | 128 | 7.8ms | 128倍 |

**假设**：100个不同资源，每个操作10ms，资源均匀分布

### 实际性能提升（考虑不均匀分布）

| 分段数 | 100个资源耗时（实际） | 性能提升（实际） |
|--------|---------------------|----------------|
| 1（全局锁） | 1000ms | 1倍（基准） |
| 8 | 150-200ms | 5-6倍 |
| 16 | 70-100ms | 10-14倍 |
| **32** | **40-60ms** | **16-25倍** |
| 64 | 25-40ms | 25-40倍 |
| 128 | 15-25ms | 40-66倍 |

**说明**：实际性能提升低于理论值，因为资源分布可能不均匀。

## 关键指标

### 当前配置（32个分段）

| 指标 | 值 | 说明 |
|------|---|------|
| **理论最大并发度** | **32** | 最多32个不同资源可以并发 |
| **实际并发度** | **10-32** | 取决于资源分布 |
| **性能提升** | **16-25倍** | 相比全局锁 |
| **适用场景** | **50-500个并发请求** | 中等规模并发 |
| **内存开销** | **中等** | 32个map |

### 全局锁（无分段）

| 指标 | 值 | 说明 |
|------|---|------|
| **理论最大并发度** | **1** | 所有操作串行 |
| **实际并发度** | **1** | 无并发 |
| **性能提升** | **1倍（基准）** | 无提升 |
| **适用场景** | **< 10个并发请求** | 低并发 |
| **内存开销** | **低** | 1个map |

## 性能测试建议

### 测试场景1：理想分布

```go
// 测试32个不同资源，均匀分布到32个分段
resources := []string{
    "sha256:resource1", "sha256:resource2", ..., "sha256:resource32"
}
// 预期：32个资源并发，总耗时 = 单操作耗时
```

### 测试场景2：实际分布

```go
// 测试100个不同资源，可能不均匀分布
resources := []string{
    "sha256:resource1", "sha256:resource2", ..., "sha256:resource100"
}
// 预期：总耗时 = max(各分段耗时) ≈ 100/32 × 单操作耗时
```

### 测试场景3：高并发

```go
// 测试500个不同资源
resources := []string{
    "sha256:resource1", "sha256:resource2", ..., "sha256:resource500"
}
// 预期：总耗时 ≈ 500/32 × 单操作耗时
```

## 总结

### 核心数据

1. **分段锁并发度**：32（理论最大）
2. **全局锁并发度**：1
3. **性能提升**：16-25倍（实际场景）
4. **适用场景**：中等规模并发（50-500个并发请求）

### 关键结论

- ✅ **分段锁大幅提升并发能力**：从1提升到32
- ✅ **实际性能提升显著**：16-25倍（考虑不均匀分布）
- ✅ **当前配置合理**：32个分段适合大多数场景
- ✅ **可根据需求调整**：高并发场景可以增加分段数

